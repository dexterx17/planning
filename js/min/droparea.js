!function($){var s,m={init:function(){},start:function(){},complete:function(){},progress:function(loaded_percent,progress_bar,area){progress_bar.css({height:loaded_percent+"%","line-height":area.height()*loaded_percent/100+"px","vertical-align":"middle"}),progress_bar.find(".bar").html(loaded_percent+"%")},before:function(){return!0},error:function(response){return 0},traverse:function(files,input,area){if("undefined"!=typeof files){m.fileCnt=files.length;for(var i=0,l=files.length;l>i;i++)m.control(files[i],input,area)}else area.html(nosupport)},control:function(file,input,area){var tld=file.name.toLowerCase().split(/\./);tld=tld[tld.length-1];var types=$(area).data("type")&&$(area).data("type").split(/,/)||[];return input.data("type")&&!types.indexOf(file.type)?(s.error({error:"only image files: "+input.data("type")},input,area),!1):file.size>1048576*s.maxsize?(s.error({error:"max upload size: "+s.maxsize+"Mb"},input,area),!1):void(s.before(file,input,area)!==!1&&(/image/i.test(file.type)&&input.data("canvas")?m.resize(file,input,area):m.upload(file,input,area)))},resize:function(file,input,area){var name=file.name,canvas=document.createElement("canvas"),img=document.createElement("img");alert(canvas.toSource());var WIDTH=0|input.data("width"),HEIGHT=0|input.data("height"),reader=new FileReader;reader.onloadend=function(e){img.src=e.target.result;var width=img.width,height=img.height,crop=input.data("crop");(WIDTH&&width>WIDTH||HEIGHT&&height>HEIGHT)&&(ratio=width/height,(ratio>=1||0==HEIGHT)&&WIDTH&&!crop?(width=WIDTH,height=WIDTH/ratio):crop&&WIDTH/HEIGHT>=ratio?(width=WIDTH,height=WIDTH/ratio):(width=HEIGHT*ratio,height=HEIGHT)),canvas.width=width,canvas.height=height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,width,height);var data=canvas.toDataURL("image/jpeg");return data.length<=6?(s.error({error:"Image did not created. Please, try again."},input,area),0):(file=m.dataURItoBlob(data),file.name=name,input.data("post")?m.upload(file,input,area):($(canvas).appendTo(area),input.attr("disabled","disabled"),$("<input>").attr("name",input.attr("name")).val(data).insertAfter(input)),void 0)},reader.readAsDataURL(file)},upload:function(file,input,area){this.fileCnt>1?area.empty():area.children("div").empty();var progress=$('<div class="progress"><div class="bar"></div></div>');area.append(progress);var xhr=new XMLHttpRequest;xhr.open("post",input.data("post"),!0);var token=$('meta[name="csrf-token"]').attr("content");token&&xhr.setRequestHeader("X-CSRF-Token",token),xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){var loaded=Math.ceil(e.loaded/e.total*100);s.progress?s.progress(loaded,progress,area):progress.html(loaded+"%")}},!1),xhr.addEventListener("load",function(e){if("200"!=e.target.status)return void s.error({error:e.target.statusText},input,area);var result=jQuery.parseJSON(e.target.responseText);s.complete(result,file,input,area),progress.addClass("uploaded"),progress.html(s.uploaded).fadeOut("slow")},!1);var fd=new FormData;for(var i in input.data())"object"!=typeof input.data(i)&&fd.append(i,input.data(i));fd.append(input.attr("name"),file),xhr.send(fd)},dataURItoBlob:function(dataURI){for(var byteString=atob(dataURI.split(",")[1]),mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);var bb=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);return bb.append(ab),bb.getBlob(mimeString)}};$.fn.droparea=function(o){return s={init:m.init,start:m.start,complete:m.complete,error:m.error,before:m.before,instructions:"drop a file to here",over:"drop file here!",nosupport:"No support for the File API in this web browser",noimage:"Unsupported file type!",uploaded:"Uploaded",maxsize:"10",wrap_container:!0,handle_click:!1},o&&$.extend(s,o),this.each(function(){var area=$(this),input=$(this).children("input")||$(this),instructions=$('<div class="instructions"></div>');area.prepend(instructions),1==s.wrap_container&&(area=$("<div"+($(this).attr("class")?' class="'+$(this).attr("class")+'"':"")+">").insertAfter($(this)),instructions=$("<div>").appendTo(area),input=$(this).appendTo(area)),s.init($(this)),$(this).attr("value")&&$(this).attr("value").length?$('<img src="'+$(this).attr("value")+'">').appendTo(area):instructions.addClass("instructions").html(s.instructions),s.handle_click===!0&&input.css({position:"absolute",top:"-1000px"}),$(document).bind({dragleave:function(e){e.preventDefault(),input.data("value")||area.find("img").length?instructions.removeClass("over").empty():instructions.removeClass("over").html(s.instructions)},drop:function(e){e.preventDefault(),input.data("value")||area.find("img").length?instructions.removeClass("over").empty():instructions.removeClass("over").html(s.instructions)},dragenter:function(e){e.preventDefault(),instructions.addClass("instructions over").html(s.over)},dragover:function(e){e.preventDefault(),instructions.addClass("instructions over").html(s.over)}}),this.addEventListener("drop",function(e){e.preventDefault(),s.start($(this)),m.traverse(e.dataTransfer.files,input,area),instructions.removeClass("over").empty(),input.val("")},!1),this.addEventListener("click",function(){input.click()}),input.change(function(e){m.traverse(e.target.files,input,area),input.val("")})}),this}}(jQuery);